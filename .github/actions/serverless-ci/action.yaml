name: "run-serverless-ci"
description: "Runs poetry install and runs the pytest"

inputs:
  code-artifact-account:
    required: true
    default: us-east-1
    description: "Runs poetry install and runs the pytest"
  code-artifact-domain:
    required: true
  role-to-assume:
    required: true
    description: "Runs poetry install and runs the pytest"
  aws-account-dev:
    required: true
  aws-account-tst:
    required: true
  aws-account-acc:
    required: true
  aws-account-prd:
    required: true

runs:
  using: "composite"
  steps:
    - name: checkout
      uses: actions/checkout@v2

    - name: date
      id: date
      uses: Kaven-Universe/github-action-current-date-time@v1.1.0
      with:
        format: "YYYY_MM_DD"
    - name: Start DynamoDB in GitHub Actions
      uses: rrainn/dynamodb-action@v2.0.1
    - uses: Gr1N/setup-poetry@v7

    - name: Configure AWS credentials from Test account
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: ${{inputs.role-to-assume}}
        aws-region: us-east-1
    - run: |
        export CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token --domain  ${{inputs.code-artifact-domain}} --domain-owner ${{inputs.code-artifact-account}} --query authorizationToken --output text)
        poetry config http-basic.dh_repo aws "${CODEARTIFACT_AUTH_TOKEN}"
      shell: bash
    - uses: actions/cache@v2
      with:
        path: |
          poetry.lock
          .venv
        key: ${{ steps.date.outputs.time }}-${{hashFiles('pyprotect.toml')}}
    - uses: actions/cache@v2
      with:
        path: |
          ~/cache
        key: depcache
    - uses: actions/setup-node@v2
      with:
        node-version: '14'    
        cache: 'npm'
    - uses: actions/setup-python@v1
      with:
        python-version: 3.8
    - run: poetry install
      shell: bash
    - name: Run tests
      run: poetry run pytest
      shell: bash
    - run: npm install
      shell: bash
    - run: npm install -g serverless@2
      shell: bash
    - run: mkdir dh-packages
      shell: bash
    - run: sls package --stage dev --region us-east-1 --deploymentBucketName dh-deployment-bucket-${{inputs.aws-account-dev}} --aws-target-account-id ${{inputs.aws-account-dev}} --package dh-packages/dev-us-east-1-build
      shell: bash     
    - run: sls package --stage tst --region us-east-1 --deploymentBucketName dh-deployment-bucket-${{inputs.aws-account-tst}} --aws-target-account-id ${{inputs.aws-account-dev}} --package dh-packages/tst-us-east-1-build
      shell: bash
    - run: sls package --stage acc --region us-east-1 --deploymentBucketName dh-deployment-bucket-${{inputs.aws-account-acc}} --aws-target-account-id ${{inputs.aws-account-dev}} --package dh-packages/acc-us-east-1-build
      shell: bash
    - run: sls package --stage prd --region us-east-1 --deploymentBucketName dh-deployment-bucket-${{inputs.aws-account-prd}} --aws-target-account-id ${{inputs.aws-account-dev}} --package dh-packages/prd-us-east-1-build 
      shell: bash
    - run: sls package --stage acc --region eu-west-1 --deploymentBucketName dh-deployment-bucket-${{inputs.aws-account-acc}} --aws-target-account-id ${{inputs.aws-account-dev}} --package dh-packages/acc-eu-west-1-build
      shell: bash
    - run: sls package --stage prd --region eu-west-1 --deploymentBucketName dh-deployment-bucket-${{inputs.aws-account-prd}} --aws-target-account-id ${{inputs.aws-account-dev}} --package dh-packages/prd-eu-west-1-build
      shell: bash

    - run: tar cf  packages.tar --exclude=**/requirements/* dh-packages 
      shell: bash
    # - run : aws s3 sync . s3://dh-package-repo-eu-west-1

    - uses: actions/upload-artifact@v2
      with:
        name: packages-artifact
        path: packages.tar


    


